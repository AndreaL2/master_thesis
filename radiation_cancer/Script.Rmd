---
VignetteBuilder: knitr
Suggests: BiocStyle, knitr, rmarkdown
title: "TFM"
author: "Elia Palma Rojo"
output: 
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8} 
---

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, warning = FALSE,
                      comment = "", cache = TRUE)
```

```{r general libraries}
library(tidyverse)
library(SummarizedExperiment)
```
```{r data, eval=FALSE}
load("data/rse_gene.Rdata")
# Pick only information about solid tissue normal (constitutional expression)
sel <- grep("-11A",rse_gene$cgc_sample_id,value=TRUE)
# Select those with new tumor events information and with or without radiation therapy
mask <- rse_gene$cgc_sample_id%in%sel & 
  rse_gene$cgc_case_new_tumor_event_after_initial_treatment%in%c("NO","YES") &
  rse_gene$xml_radiation_therapy%in%c("NO", "YES") 
rse_subset<-rse_gene[,mask]
rse_subset$xml_radiation_therapy<-droplevels(rse_subset$xml_radiation_therapy,exclude=c("0","1","2","70","80","90","pT2a","pT2c"))
rse_subset$cgc_case_new_tumor_event_after_initial_treatment<-as.factor(rse_subset$cgc_case_new_tumor_event_after_initial_treatment)
# Create a new file with the specific information
save(rse_subset,file="rse_subset.Rdata")
```
# Exploratory analysis

```{r subset exploratory analysis}
load("rse_subset.Rdata")

# Tumor stage variable
stage <- rse_subset$gdc_cases.diagnoses.tumor_stage
ids.early <- grep(paste("stage i$", "stage ia$", "stage ib$" ,
                        "stage ic$", "stage ii$", "stage iia$",
                        "stage iib$" , "stage iic$",
                        sep="|"), stage)
ids.late <- grep(paste("stage iii$", "stage iiia$", "stage iiib$" ,
                        "stage iiic$", "stage iv$", "stage iva$",
                        "stage ivb$" , "stage ivc$",
                        sep="|"), stage)
colData(rse_subset)$GROUP <- rep(NA, ncol(rse_subset))
colData(rse_subset)$GROUP[ids.early] <- "early"
colData(rse_subset)$GROUP[ids.late] <- "late"

#New column combining radiation and tumor information
colData(rse_subset)$radiation_tumor <- rep(NA, ncol(rse_subset))
rse_subset$radiation_tumor[rse_subset$xml_radiation_therapy=="YES" & rse_subset$cgc_case_new_tumor_event_after_initial_treatment=="YES"]<-"YES" 
rse_subset$radiation_tumor[rse_subset$xml_radiation_therapy!="YES" | rse_subset$cgc_case_new_tumor_event_after_initial_treatment!="YES"]<-"NO"
 

rse_subset$radiation_tumor<-as.factor(rse_subset$radiation_tumor)
rse_subset$gdc_cases.demographic.gender<-as.factor(rse_subset$gdc_cases.demographic.gender)
rse_subset$gdc_cases.demographic.ethnicity<-as.factor(rse_subset$gdc_cases.demographic.ethnicity)
rse_subset$cgc_case_primary_site<-as.factor(rse_subset$cgc_case_primary_site)
rse_subset$gdc_cases.demographic.ethnicity<-droplevels(rse_subset$gdc_cases.demographic.ethnicity,exclude="not reported")
rse_subset$xml_tissue_source_site<-droplevels(rse_subset$xml_tissue_source_site)
rse_subset$GROUP<-as.factor(rse_subset$GROUP)

# Generation of the variable phenotype (pheno) and count data (counts)
pheno<-colData(rse_subset)
counts<-assay(rse_subset)

#Subset of variables for the exploratory analysis
sub<-subset(pheno,select=c("gdc_cases.demographic.gender","gdc_cases.demographic.ethnicity","GROUP","cgc_case_age_at_diagnosis","cgc_case_primary_site","radiation_tumor","xml_tissue_source_site"))

sub<-as.data.frame(sub)
str(sub)
```

```{r exploratory analysis 2}
library(compareGroups)
# Table representation of 2 variables of interest
mytable<-as.matrix(table(pheno$cgc_case_new_tumor_event_after_initial_treatment,pheno$xml_radiation_therapy))
names(dimnames(mytable))<-c("new tumor event","radiation therapy")
mytable
write.csv2(mytable,"2xtable.csv")
# Results of the exploratory analysis
results<-compareGroups(radiation_tumor~.,data=sub,max.xlev=32,na.action = na.pass)
results.table<-createTable(results)
results
results.table
plot(results,bivar=TRUE)
```

# VOOM-LIMMA

```{r filtering and normalization for limma}
library(edgeR)

dge<-DGEList(counts=counts)
dim(dge)
#Remove rows with 0 or low counts
keep<-filterByExpr(dge)
dge<-dge[keep,,keep.lib.sizes=FALSE]
dim(dge)
#Scale normalization to RNA-seq read counts with TMM
dge<-calcNormFactors(dge)
dge<-estimateCommonDisp(dge)
dge$common.dispersion
#coefficient of variation, proportion by which true expression levels may vary between replicate samples.
sqrt(dge$common.dispersion)
```
```{r voom}
library(limma)

#Create a full model matrix and a null model that contains all and only the adjustment variables respectively
mod<-model.matrix(~xml_radiation_therapy*cgc_case_new_tumor_event_after_initial_treatment,data=pheno)
mod0<- model.matrix(~xml_radiation_therapy+cgc_case_new_tumor_event_after_initial_treatment,data=pheno)
v<-voom(counts=dge,plot=TRUE,design=mod)
```
```{r SVA limma}
library(sva)
#Surrogate variable analysis
n.sv<-num.sv(v$E,mod,method="leek")
n.sv
svobj<-sva(v$E, mod, mod0, method="irw",n.sv=n.sv)
modSv<-cbind(mod,svobj$sv)
mod0Sv<-cbind(mod0,svobj$sv)
```
```{r limma}
#Limma
fit <- lmFit(v,modSv)
fit <- eBayes(fit)
#Results
deGenes<-topTable(fit, coef=4,sort.by="p",number=34854,lfc=log2(1.5))
head(deGenes)
```

Given that all the obtained adjusted P values were higher than 0.05, the genes shown here are those with a p value (not adjusted) smaller than 0.001

```{r enrichment}
mask.deGenes<-deGenes$P.Value<0.001
masked.deGenes<-deGenes[mask.deGenes,]
#Obtain ENSEMBL names
deGenes_splt<-rownames(masked.deGenes)
deGenes_splt<-unlist(strsplit(deGenes_splt, "[.]"))
deGenes_splt<-subset(deGenes_splt, grepl("^EN", deGenes_splt))
deGenes_splt
geneUniverse<-rownames(fit)
geneUniverse_splt<-unlist(strsplit(geneUniverse, "[.]"))
geneUniverse_splt<-subset(geneUniverse_splt, grepl("^EN", geneUniverse_splt))
#Enrichment analysis
library(org.Hs.eg.db)
geneUniverse <- unlist(mget(geneUniverse_splt, org.Hs.egENSEMBL2EG, 
                            ifnotfound=NA))
deGenes_2 <- unlist(mget(deGenes_splt, org.Hs.egENSEMBL2EG, 
                      ifnotfound=NA))
```
```{r ENSEMBL/ENTREZ/SYMBOL ID}
#ENSEMBL, ENTREZ and SYMBOL IDs for gene set and gene universe respectively
library(clusterProfiler)
eg<-bitr(deGenes_splt,fromType="ENSEMBL",toType=c("ENTREZID","SYMBOL"), OrgDb="org.Hs.eg.db")
eg
eg_universe<-bitr(geneUniverse_splt,fromType="ENSEMBL",toType=c("ENTREZID","SYMBOL"), OrgDb="org.Hs.eg.db")
head(eg_universe)
```

## GO
```{r GO limmma}
library(GOstats)
params <- new("GOHyperGParams", geneIds=deGenes_2,
              universeGeneIds=geneUniverse, ontology = 'BP',
              annotation="org.Hs.eg.db",
              pvalueCutoff=0.05, conditional=FALSE,
              testDirection="over")
hgOver <- hyperGTest(params)
#html file with all the results
htmlReport(hgOver, file="goBPlimma.html")
#Top signalling pathways
head(summary(hgOver))
```
```{r GO classification}
# gene classification based on GO distribution
ggo<-groupGO(gene=eg$ENTREZID,
             OrgDb = org.Hs.eg.db,
             ont="CC",
             readable = TRUE)
head(ggo)
barplot(ggo,drop=TRUE,showCategory=12)
```

```{r GO over-representation}
#GO over-representation analysiss
ego<-enrichGO(gene =deGenes_splt,
              universe = geneUniverse_splt,
              keyType = 'ENSEMBL',
              OrgDb = org.Hs.eg.db,
              ont = "CC",
              pAdjustMethod = "BH",
              pvalueCutoff = 0.01,
              qvalueCutoff  = 0.05,
        readable = TRUE)
head(ego)
barplot(ego,drop=TRUE,showCategory = 8)
emapplot(ego)

goplot(ego)

#In order to consider the potentially biological complexities in which a gene may belong to multiple annotation categories and provide information of numeric changes if available, cnetplot extracts the complex association.
cnetplot(ego,categorySize="pvalue")
```

## KEGG
```{r kegg}
#KEGG
library(KEGG.db)
params.kegg <- new("KEGGHyperGParams", geneIds=deGenes_2,
                   universeGeneIds=geneUniverse,
                   annotation="org.Hs.eg.db", 
                   pvalueCutoff=0.05, 
                   testDirection="over")
hg_kegg <- hyperGTest(params.kegg)
summary(hg_kegg)
```

# DESeq

```{r deseq}
library(BiocParallel)
library(DESeq2)

register(MulticoreParam(10))
identical(colnames(counts),rownames(pheno))
dds<-DESeqDataSetFromMatrix(countData = counts,colData=pheno,design=~xml_radiation_therapy*cgc_case_new_tumor_event_after_initial_treatment)
#Pre-filtering
nrow(dds)
dds<-dds[rowSums(counts(dds))>=10,]
nrow(dds)

dds<-DESeq(dds,parallel=TRUE,BPPARAM=MulticoreParam(10))

dds2 <- dds
temp<-colData(dds2)
temp2 <- cbind(temp, svobj$sv)
colData(dds2) <- temp2

design(dds2)

mm1 <- paste0(design(dds2), collapse="")
mm2 <- paste0(paste0("V", 1:99), collapse="+")
design(dds2) <- formula(paste(mm1, mm2, sep="+"))

dds2 <- DESeq(dds2,parallel=TRUE,BPPARAM=MulticoreParam(10))
```

```{r results deseq}
res<-results(dds2,name="xml_radiation_therapyYES.cgc_case_new_tumor_event_after_initial_treatmentYES",lfcThreshold =log2(1.5),alpha=0.05)
# Show the log2 fold changes. Points will be colored red if the adjusted p value is less than 0.1. Points which fall out of the window are plotted as open triangles pointing either up or down.
plotMA(res)
#Shrinked
resLFC <- lfcShrink(dds, coef="xml_radiation_therapyYES.cgc_case_new_tumor_event_after_initial_treatmentYES", type="apeglm")
resLFC
plotMA(resLFC,ylim=c(-3,3))
abline(h=c(-1,1),col="dodgerblue",lwd=2)
# Order the results according to padj (from lower to higher)
res2<-subset(res,padj<0.05)
res2<-subset(res2,na.rm=TRUE)
res2<-res2[order(res2$padj),]
dim(res2)
head(res2)
write.csv2(res2,"all_ENSEMBL_genes.csv")
```
```{r GO gene names deseq}
#All genes
deGenes.deseq<-rownames(res2)
deGenes.deseq<-unlist(strsplit(deGenes.deseq, "[.]"))
deGenes.deseq<-subset(deGenes.deseq, grepl("^EN", deGenes.deseq))
geneUniverse.deseq<-rownames(dds2)
geneUniverse.deseq2<-unlist(strsplit(geneUniverse.deseq, "[.]"))
geneUniverse.deseq2<-subset(geneUniverse.deseq2, grepl("^EN", geneUniverse.deseq2))
```
ENSEMBL, ENTREZ and UNIPROT IDs for gene set and gene universe
```{r deseq ENSEMBL/ENTREZ/UNIPROT ID}
eg2<-bitr(deGenes.deseq,fromType="ENSEMBL",toType=c("ENTREZID","SYMBOL"), OrgDb="org.Hs.eg.db")
head(eg2)
dim(eg2)
#Report gene names
write.csv2(eg2, "all_gene_names.csv")

eg2_universe<-bitr(geneUniverse.deseq2,fromType="ENSEMBL",toType=c("ENTREZID","SYMBOL"), OrgDb="org.Hs.eg.db")
```

```{r GO gene names up and down}
#Plot the results with some of the genes up and down regulated
library(ggpubr)
ggmaplot(res, main = "radiation therapy and new tumor event",
   fdr = 0.05, fc = 2, size = 0.4,
   palette = c("#B31B21", "#1465AC", "darkgray"),
   genenames = as.vector(rownames(res)),
   legend = "top", top = 20,
   font.label = c("bold", 11),
   font.legend = "bold",
   font.main = "bold",
   ggtheme = ggplot2::theme_minimal())

#Upregulated genes
ur.genes<-rownames(subset(res2,log2FoldChange>1))
ur.genes<-unlist(strsplit(ur.genes, "[.]"))
ur.genes<-subset(ur.genes, grepl("^EN", ur.genes))
ur.genes2<-bitr(ur.genes,fromType="ENSEMBL",toType=c("ENTREZID","SYMBOL"), OrgDb="org.Hs.eg.db")
head(ur.genes2)
write.csv2(ur.genes2, "upregulated_genes.csv")

#Downregulated genes
dr.genes<-rownames(subset(res2,log2FoldChange<(-1)))
dr.genes<-unlist(strsplit(dr.genes, "[.]"))
dr.genes<-subset(dr.genes, grepl("^EN", dr.genes))
dr.genes2<-bitr(dr.genes,fromType="ENSEMBL",toType=c("ENTREZID","SYMBOL"), OrgDb="org.Hs.eg.db")
head(dr.genes2)
write.csv2(dr.genes2, "downregulated_genes.csv")
```
```{r enrichment deseq}
geneUniverse.deseq <- unlist(mget(geneUniverse.deseq2, org.Hs.egENSEMBL2EG, 
                            ifnotfound=NA))
deGenes.deseq2 <- unlist(mget(deGenes.deseq, org.Hs.egENSEMBL2EG, 
                      ifnotfound=NA))
deGenes.ur<- unlist(mget(ur.genes, org.Hs.egENSEMBL2EG, 
                      ifnotfound=NA))
deGenes.dr<- unlist(mget(dr.genes, org.Hs.egENSEMBL2EG, 
                      ifnotfound=NA))
```

## GO

Gene ontology analysis.
Ontology:
- BP:biological process
- MF: molecular function
- CC: cellular component
```{r GO deseq 2}
# All genes
params2 <- new("GOHyperGParams", geneIds=deGenes.deseq2,
              universeGeneIds=geneUniverse.deseq, ontology = 'BP',
              annotation="org.Hs.eg.db",
              pvalueCutoff=0.05, conditional=FALSE,
              testDirection="over")
hgOver2 <- hyperGTest(params2)
htmlReport(hgOver2, file="go_deseq.html")
head(summary(hgOver2))

# Down and Up regulated separately
params2.ur <- new("GOHyperGParams", geneIds=deGenes.ur,
              universeGeneIds=geneUniverse.deseq, ontology = 'BP',
              annotation="org.Hs.eg.db",
              pvalueCutoff=0.05, conditional=FALSE,
              testDirection="over")
hgOver2.ur <- hyperGTest(params2.ur)
htmlReport(hgOver2.ur, file="go_deseq_ur.html")
head(summary(hgOver2.ur))
params2.dr <- new("GOHyperGParams", geneIds=deGenes.dr,
              universeGeneIds=geneUniverse.deseq, ontology = 'BP',
              annotation="org.Hs.eg.db",
              pvalueCutoff=0.05, conditional=FALSE,
              testDirection="over")
hgOver2.dr <- hyperGTest(params2.dr)
htmlReport(hgOver2.dr, file="go_deseq_dr.html")
head(summary(hgOver2.dr))
```

```{r GO deseq classification}
#Classification
ggo2<-groupGO(gene=eg2$ENTREZID,
             OrgDb = org.Hs.eg.db,
             ont="CC",
             level=4,
             readable = TRUE)
head(ggo2)
barplot(ggo2,drop=TRUE,showCategory=20)
```


```{r deseq GO over-representation}
#GO over-representation analysis
ego2<-enrichGO(gene =deGenes.deseq,
              universe = geneUniverse.deseq2,
              keyType = 'ENSEMBL',
              OrgDb = org.Hs.eg.db,
              ont = "BP",
              pAdjustMethod = "BH",
              pvalueCutoff = 0.01,
              qvalueCutoff  = 0.05,
        readable = TRUE)
head(ego2)
barplot(ego2,drop=TRUE,showCategory = 10)
emapplot(ego2)

goplot(ego2)

#In order to consider the potentially biological complexities in which a gene may belong to multiple annotation categories and provide information of numeric changes if available, cnetplot function is used to extract the complex associations.
cnetplot(ego2,categorySize="pvalue",colorEdge=TRUE)

```

## KEGG
```{r deseq KEGG}
params.kegg2 <- new("KEGGHyperGParams", geneIds=deGenes.deseq2,
                   universeGeneIds=geneUniverse.deseq,
                   annotation="org.Hs.eg.db", 
                   pvalueCutoff=0.05, 
                   testDirection="over")
hg_kegg2 <- hyperGTest(params.kegg2)
summary(hg_kegg2)
#Upregulated
params.kegg2.ur <- new("KEGGHyperGParams", geneIds=deGenes.ur,
                   universeGeneIds=geneUniverse.deseq,
                   annotation="org.Hs.eg.db", 
                   pvalueCutoff=0.05, 
                   testDirection="over")
hg_kegg2.ur <- hyperGTest(params.kegg2.ur)
summary(hg_kegg2.ur)
htmlReport(hg_kegg2.ur, file="kegg_deseq_ur.html")
#Downregulated
params.kegg2.dr <- new("KEGGHyperGParams", geneIds=deGenes.dr,
                   universeGeneIds=geneUniverse.deseq,
                   annotation="org.Hs.eg.db", 
                   pvalueCutoff=0.05, 
                   testDirection="over")
hg_kegg2.dr <- hyperGTest(params.kegg2.dr)
summary(hg_kegg2.dr)
htmlReport(hg_kegg2.dr, file="kegg_deseq_dr.html")
```
```{r deseq KEGG over-representation}
kk<-enrichKEGG(gene=eg2$ENTREZID,
               organism="hsa",
               universe=eg2_universe$ENTREZID,
               pvalueCutoff=0.05)
head(kk)
diffexp.genes2<-kk$geneID
barplot(kk,showCategory = 10)

#Upregulated
kk.ur<-enrichKEGG(gene=ur.genes2$ENTREZID,
               organism="hsa",
               universe=eg2_universe$ENTREZID,
               pvalueCutoff=0.05)
head(kk.ur)
diffexp.genes2.ur<-kk.ur$geneID
barplot(kk.ur,showCategory = 10)
#Downregulated
kk.dr<-enrichKEGG(gene=dr.genes2$ENTREZID,
               organism="hsa",
               universe=eg2_universe$ENTREZID,
               pvalueCutoff=0.05)
head(kk.dr)
diffexp.genes2.dr<-kk.dr$geneID
barplot(kk.dr,showCategory = 10)
```

## WikiPathways

Is a more focused approach than GO.
For over representation analysis. ClusterProfiler provides enricher function for hypergeometric test. They accept two additional parameter TERM2GENE and TERM2NAME. 
WikiPathways is a continuously updated pathway database

```{r enricher clusterprofiler}
library(magrittr)
gene<-eg2$ENTREZID
gene.up<-dr.genes2$ENTREZID
gene.down<-ur.genes2$ENTREZID

#Open WikiPathways (updated pathway database) file
wp2gene <- read.gmt("wikipathways-20190410-gmt-Homo_sapiens.gmt")
wp2gene <- wp2gene %>% tidyr::separate(ont, c("name","version","wpid","org"), "%")

#TERM2GENE
wpid2gene <- wp2gene %>% dplyr::select(wpid, gene)

#TERM2NAME
wpid2name <- wp2gene %>% dplyr::select(wpid, name)

#Enricher function
ewp <- enricher(gene, TERM2GENE = wpid2gene, TERM2NAME = wpid2name)
ewp <- setReadable(ewp, org.Hs.eg.db, keytype = "ENTREZID")
#To add the gene symbols we are going to use the package DOSE
library(DOSE)
ewp<-DOSE::setReadable(ewp, org.Hs.eg.db, keytype = "ENTREZID")
#Representation
head(ewp)
barplot(ewp)
dotplot(ewp, showCategory = 20)
emapplot(ewp, showCategory = 20)
```


## MSigDb analysis

MSigDB is a collection of annotated gene sets
```{r MSigDb analysis all set}
#Molecular Signatures Database. 
library(msigdbr)
#To retrieve all human gene sets
m_df <- msigdbr(species = "Homo sapiens")
head(m_df, 2) %>% as.data.frame
```
Gene sets represent signatures of cellular pathways which are often dis-regulated in cancer. The majority of signatures were generated directly from microarray data from NCBI GEO or from internal unpublished profiling experiments which involved perturbation of known cancer genes. In addition, a small number of oncogenic signatures were curated from scientific publications. 
```{r MSigDb oncogenes}
#Oncogenic collection
m_t2g <- msigdbr(species = "Homo sapiens", category = "C6") %>% 
  dplyr::select(gs_name, entrez_gene)
head(m_t2g)
em<-enricher(gene,TERM2GENE=m_t2g)
head(em)

em.up<-enricher(gene.up,TERM2GENE=m_t2g)
head(em.up)

em.down<-enricher(gene.down,TERM2GENE=m_t2g)
head(em.down)
```
Immunologic signatures collection (also called ImmuneSigDB) is composed of gene sets that represent cell types, states, and perturbations within the immune system. The signatures were generated by manual curation of published studies in human and mouse immunology. 
```{r MSigDb immunologic gs}
#Immunologic collection
m_t2g2 <- msigdbr(species = "Homo sapiens", category = "C7") %>% 
  dplyr::select(gs_name, entrez_gene)
head(m_t2g2)
em2<-enricher(gene,TERM2GENE=m_t2g2)
head(em2)
em2.up<-enricher(gene.up,TERM2GENE=m_t2g2)
head(em2.up)

em2.down<-enricher(gene.down,TERM2GENE=m_t2g2)
head(em2.down)
```